<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }

        .instructions {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .key {
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="instructions">
        <p><a href="/"> &larr; Retour à la page d'acceuil du site</a></p>

        <h1>Automate cellulaire : simulation d'eau</h1>
        <h2>Contrôles :</h2>
        <div class="controls">
            <span class="key">E</span> Mode placement d'eau
            <span class="key">W</span> Mode placement de murs
            <span class="key">A</span> Mode placement d'air
        </div>

        <p><strong>Instructions :</strong> Dessinez les murs souhaités à l'aide de la souris puis changez de mode pour
            ajouter de l'eau avec la souris également.</p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.1.9/lib/p5.js"></script>
    <script>

        class ArrayList extends Array {
            constructor() {
                super(...[]);
            }
            size() {
                return this.length;
            }
            add(x) {
                this.push(x);
            }
            get(i) {
                return this[i];
            }
            remove(i) {
                this.splice(i, 1);
            }
        }

        // [processing-p5-convert] import java.util.ArrayList;
        var windowSize = 400;
        var cellSize = 10;
        var cellNumber;
        var grid;
        var index_water_max = 1;
        var mode = 0;
        var run = false;
        var drops = new ArrayList();
        function setup() {
            createCanvas(400, 400);
            initialize();
        }
        function draw() {
            background(20);
            for (var i = 0; i < drops.length; i++) {
                grid[drops[i].x][drops[i].y] = 0;
                drops[i].nextStep(grid);
                grid[drops[i].x][drops[i].y] = i + 1;
                console.log(drops[i].x, drops[i].y);
            }
            showGrid();
            text("E : Water ; W : Wall ; A: Air ; Click tou place", 25, 30);
        }
        function keyPressed() {
            if (key == "W" || key == "w") {
                // WALL
                mode = 0;
            } else if (key == "E" || key == "e") {
                // WATER
                mode = 1;
            } else if (key == "A" || key == "a") {
                // AIR
                mode = 2;
            } else if (keyCode == ENTER) {
                run = true;

            }
        }
        function mouseDragged() {
            if (
                int(mouseX / cellSize) >= 0 &&
                int(mouseX / cellSize) < cellNumber &&
                int(mouseY / cellSize) >= 0 &&
                int(mouseY / cellSize) < cellNumber
            ) {
                if (mode == 0) {
                    // WALL
                    grid[int(mouseX / cellSize)][cellNumber - int(mouseY / cellSize) - 1] = -1;
                } else if (mode == 1) {
                    // WATER
                    index_water_max += 1;
                    grid[int(mouseX / cellSize)][cellNumber - int(mouseY / cellSize) - 1] =
                        index_water_max;
                    drops.add(
                        new water(
                            int(mouseX / cellSize),
                            cellNumber - int(mouseY / cellSize) - 1,
                            cellSize
                        )
                    );
                } else if (mode == 2) {
                    // AIR
                    grid[int(mouseX / cellSize)][cellNumber - int(mouseY / cellSize) - 1] = 0;
                }
            }
        }
        function initialize() {
            cellNumber = windowSize / cellSize;
            grid = Array.from(new Array(cellNumber), () => new Array(cellNumber));
            for (var i = 0; i < cellNumber; i++) {
                for (var j = 0; j < cellNumber; j++) {
                    grid[i][j] = 0;
                }
            }
        }
        function showGrid() {
            for (var i = 0; i < cellNumber; i++) {
                for (var j = 0; j < cellNumber; j++) {
                    push();
                    noStroke();
                    if (grid[i][j] == -1) {
                        fill(0);
                    } else if (grid[i][j] > 0) {
                        fill(0, 0, 250);
                    } else {
                        fill(210);
                    }
                    rect(
                        i * cellSize,
                        (cellNumber - 1 - j) * cellSize,
                        cellSize,
                        cellSize
                    );
                    pop();
                }
            }
        }

        // [processing-p5-convert] import java.util.ArrayList;
        class water {
            x;
            y;
            size;
            constructor(x_, y_, size_) {
                this.x = x_;
                this.y = y_;
                this.size = size_;
            }
            nextStep(grid) {
                if (this.y > 0) {
                    if (grid[this.x][this.y - 1] == 0) {
                        this.y -= 1;
                    } else {
                        var sign = this.lookForPath(grid);
                        this.x += sign;
                    }
                }
            }
            lookForPath(grid) {
                var countLeft = 0;
                var countRight = 0;
                var res = 0;
                var stopRight = false;
                var stopLeft = false;
                while (res == 0 && !(stopRight && stopLeft)) {
                    if (!stopRight && countRight < grid[1].length - this.x) {
                        if (grid[this.x + countRight][this.y] != 0) {
                            stopRight = true;
                        } else if (grid[this.x + countRight][this.y - 1] == 0) {
                            res = 1;
                        }
                    }
                    if (countRight > grid[1].length - this.x) {
                        stopRight = true;
                    }
                    if (!stopLeft && countLeft <= this.x) {
                        if (grid[this.x - countLeft][this.y] != 0) {
                            stopLeft = true;
                        } else if (grid[this.x - countLeft][this.y - 1] == 0) {
                            if (res == +1) {
                                res = random([-1, 1]);
                            } else {
                                res = -1;
                            }
                        }
                    }
                    if (countLeft > this.x) {
                        stopLeft = true;
                    }
                    countRight += 1;
                    countLeft += 1;
                }
                return res;
            }
        }

    </script>